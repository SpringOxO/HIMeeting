<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Mediasoup åç«¯åŠŸèƒ½éªŒè¯å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { display: flex; gap: 20px; }
        video { width: 320px; height: 240px; background: #333; }
        .status { margin-top: 15px; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.js"></script>
    
    <script src="./meeting-server/build/mediasoup-client.bundle.js"></script> 
</head>
<body>

    <h2>Mediasoup SFU éªŒè¯å™¨</h2>
    <p>è¯¥é¡µé¢ç”¨äºéªŒè¯ NestJS åç«¯åˆ›å»º Transportã€Producerã€Consumer çš„é€»è¾‘æ˜¯å¦æ­£ç¡®ã€‚</p>
    <button id="startButton" onclick="startConference()">å¯åŠ¨ä¼šè®®å¹¶å‘å¸ƒæµ</button>
    <div class="status">çŠ¶æ€: <span id="status">æœªè¿æ¥</span></div>

    <div class="container">
        <div>
            <h3>æˆ‘çš„ç”»é¢ (Producer)</h3>
            <video id="localVideo" autoplay muted playsInline></video>
        </div>
        <div>
            <h3>è¿œç¨‹ç”»é¢ (Consumer)</h3>
            <video id="remoteVideo" autoplay playsInline style="background: #000;"></video>
        </div>
    </div>
    
    <script>
        // ğŸš¨ æ›¿æ¢æˆä½ çš„åç«¯åœ°å€
        const SERVER_URL = 'http://localhost:3000';
        const ROOM_ID = 'quick-test-room';
        
        // å…¨å±€çŠ¶æ€ç®¡ç†
        let socket;
        let device;
        let sendTransport;
        let recvTransport;
        let remoteProducerIds = [];
        
        // =========================================================================
        // å®ç”¨å·¥å…·å‡½æ•°
        // =========================================================================
        
        /** æ›´æ–°çŠ¶æ€æ  */
        const updateStatus = (msg) => {
            document.getElementById('status').textContent = msg;
            console.log(msg);
        };

        /** å°† Socket è¯·æ±‚/å“åº”å°è£…æˆ Promise */
        const request = (event, data = {}) => {
            return new Promise((resolve, reject) => {
                // ä½¿ç”¨å›è°ƒå‡½æ•° (Ack) æ¥æ”¶åç«¯å“åº”
                socket.emit(event, data, (response) => {
                    if (response && response.error) {
                        console.error(`Socket Error [${event}]:`, response.error);
                        reject(response.error);
                    } else {
                        resolve(response);
                    }
                });
            });
        };

        // =========================================================================
        // ä¸»æµç¨‹
        // =========================================================================

        async function startConference() {
            document.getElementById('startButton').disabled = true;
            updateStatus('æ­£åœ¨è¿æ¥ä¿¡ä»¤æœåŠ¡å™¨...');

            // 1. è¿æ¥ Socket.io
            socket = io(SERVER_URL);

            socket.on('connect', async () => {
                updateStatus('è¿æ¥æˆåŠŸï¼Œè¯·æ±‚åŠ å…¥æˆ¿é—´...');

                // 2. åŠ å…¥æˆ¿é—´å¹¶è·å– Router èƒ½åŠ›
                const { rtpCapabilities } = await request('joinRoom', { roomId: ROOM_ID });

                // 3. åˆå§‹åŒ– Mediasoup Device
                device = new MediasoupClient.Device();
                await device.load({ routerRtpCapabilities: rtpCapabilities });
                updateStatus('Mediasoup Device åŠ è½½å®Œæˆã€‚');

                // 4. ç›‘å¬æ–°æµäº‹ä»¶ (å½“å…¶ä»–ç”¨æˆ·å‘å¸ƒæµæ—¶)
                socket.on('newProducer', async ({ producerId }) => {
                    console.log(`æ”¶åˆ°æ–°æµé€šçŸ¥: ${producerId}`);
                    remoteProducerIds.push(producerId);
                    
                    // ç¡®ä¿æ¥æ”¶ Transport åˆ›å»ºå®Œæˆåï¼Œæ‰å¼€å§‹æ¶ˆè´¹
                    if (recvTransport) {
                        await consumeNewStream(producerId);
                    }
                });

                // 5. å¯åŠ¨ç”Ÿäº§å’Œæ¶ˆè´¹æµç¨‹
                await createRecvTransport(); // å…ˆå‡†å¤‡æ¥æ”¶ç®¡é“
                await publishMyStream();     // å†å‘å¸ƒæˆ‘çš„æµ
            });
            
            socket.on('disconnect', () => updateStatus('è¿æ¥æ–­å¼€'));
        }

        // --- A. ç”Ÿäº§ (Publish) æµç¨‹ ---
        async function publishMyStream() {
            updateStatus('æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´/éº¦å…‹é£æƒé™...');
            // 1. è·å–æœ¬åœ°åª’ä½“
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
            document.getElementById('localVideo').srcObject = stream;

            // 2. è¯·æ±‚åç«¯åˆ›å»ºå‘é€ Transport
            const params = await request('createWebRtcTransport', { roomId: ROOM_ID });
            sendTransport = device.createSendTransport(params);

            // 3. ç›‘å¬ Transport è¿æ¥äº‹ä»¶ (DTLS æ¡æ‰‹)
            sendTransport.on('connect', async ({ dtlsParameters }, callback, errback) => {
                try {
                    await request('connectTransport', {
                        roomId: ROOM_ID,
                        transportId: sendTransport.id,
                        dtlsParameters,
                    });
                    callback();
                } catch (error) {
                    errback(error);
                }
            });

            sendTransport.on('produce', async ({ kind, rtpParameters, appData }, callback, errback) => {
                try {
                    // å‘åç«¯å‘é€ä¿¡ä»¤ï¼Œè®©åç«¯åˆ›å»º Producer
                    const { id } = await request('produce', {
                        roomId: ROOM_ID,
                        transportId: sendTransport.id,
                        kind,
                        rtpParameters,
                        // appData: appData, // å¯é€‰
                    });

                    // æˆåŠŸåï¼Œå°†åç«¯åˆ›å»ºçš„ Producer ID è¿”å›ç»™å®¢æˆ·ç«¯çš„ produce() è°ƒç”¨
                    callback({ id });
                } catch (error) {
                    errback(error);
                }
            });

            // 4. å‘å¸ƒæœ¬åœ°æµ (Produce)
            const videoTrack = stream.getVideoTracks()[0];
            const audioTrack = stream.getAudioTracks()[0];

            await sendTransport.produce({ track: videoTrack });
            await sendTransport.produce({ track: audioTrack });

            updateStatus('æœ¬åœ°æµå‘å¸ƒæˆåŠŸ (Producer)');
        }

        // --- B. æ¶ˆè´¹ (Consume) æµç¨‹ - Transport åˆ›å»º ---
        async function createRecvTransport() {
            // 1. è¯·æ±‚åç«¯åˆ›å»ºæ¥æ”¶ Transport
            const params = await request('createWebRtcTransport', { roomId: ROOM_ID });
            recvTransport = device.createRecvTransport(params);

            // 2. ç›‘å¬ Transport è¿æ¥äº‹ä»¶ (DTLS æ¡æ‰‹)
            recvTransport.on('connect', async ({ dtlsParameters }, callback, errback) => {
                try {
                    await request('connectTransport', {
                        roomId: ROOM_ID,
                        transportId: recvTransport.id,
                        dtlsParameters,
                    });
                    callback();
                } catch (error) {
                    errback(error);
                }
            });
            
            updateStatus('æ¥æ”¶ Transport ç®¡é“å·²å‡†å¤‡å°±ç»ª...');

            // 3. å¦‚æœæœ‰Producerå·²ç»å‘å¸ƒäº†ï¼Œä½†å› ä¸ºTransportæœªåˆ›å»ºè€Œé”™è¿‡äº†ï¼Œç°åœ¨å¼€å§‹æ¶ˆè´¹
            for (const producerId of remoteProducerIds) {
                await consumeNewStream(producerId);
            }
        }
        
        // --- C. æ¶ˆè´¹ (Consume) æµç¨‹ - è®¢é˜…æµ ---
        async function consumeNewStream(producerId) {
            if (!recvTransport) return; 

            // 1. è¯·æ±‚åç«¯æ¶ˆè´¹æµ
            const { id, kind, rtpParameters } = await request('consume', {
                roomId: ROOM_ID,
                transportId: recvTransport.id,
                producerId,
                rtpCapabilities: device.rtpCapabilities,
            });

            // 2. å‰ç«¯åˆ›å»º Consumer
            const consumer = await recvTransport.consume({
                id,
                producerId,
                kind,
                rtpParameters,
            });

            // ==========================================================
            // ğŸš€ æ ¸å¿ƒä¿®å¤ï¼šå¤„ç†å¤š Track å’Œ Unmute é€»è¾‘
            // ==========================================================
            
            // è·å– HTML ä¸Šçš„ Video å…ƒç´ 
            const videoElement = document.getElementById('remoteVideo');
            
            // åˆ›å»ºä¸€ä¸ªæ–°çš„ MediaStream (å¦‚æœä¹‹å‰å·²ç»æœ‰äº†ï¼Œå¤ç”¨å®ƒä¼šæ›´å¥½ï¼Œä½†è¿™é‡Œä¸ºäº†ç®€å•ç›´æ¥æ–°å»º)
            // æ³¨æ„ï¼šå¦‚æœå…ˆæ¥äº†éŸ³é¢‘ï¼Œè¿™é‡Œè¦†ç›–å¯èƒ½ä¼šå¯¼è‡´éŸ³é¢‘ä¸¢å¤±ï¼Œå»ºè®®åˆ†å¼€æµ‹è¯•æˆ–åˆå¹¶æµ
            let stream = videoElement.srcObject;
            if (!stream) {
                stream = new MediaStream();
                videoElement.srcObject = stream;
            }
            
            // æŠŠæ–°çš„ track åŠ è¿›å»
            stream.addTrack(consumer.track);

            // ã€å…³é”®ã€‘å¦‚æœ Track ç°åœ¨æ˜¯é™é»˜çš„ï¼Œç­‰å¾…å®ƒæœ‰æ•°æ®åå†åˆ·æ–°
            if (!consumer.track.muted) {
                // å·²ç»åœ¨æ’­æ”¾äº†
                console.log(`Track ${kind} is live immediately.`);
            }

            // ç›‘å¬ unmute äº‹ä»¶ï¼šä¸€æ—¦æ”¶åˆ°ç¬¬ä¸€ä¸ªåŒ…ï¼Œè¿™é‡Œä¼šè§¦å‘
            consumer.track.onunmute = () => {
                console.log(`Track ${kind} unmuted (received data)!`);
                // æš´åŠ›åˆ·æ–°ï¼šæœ‰æ—¶å€™æµè§ˆå™¨éœ€è¦é‡æ–°èµ‹å€¼ srcObject æ‰èƒ½æ¸²æŸ“å‡ºç¬¬ä¸€å¸§
                videoElement.srcObject = stream; 
            };

            // 3. å‘Šè¯‰åç«¯æ¢å¤æµ
            await request('resumeConsumer', { 
                roomId: ROOM_ID, 
                consumerId: consumer.id 
            });

            // 4. è¯·æ±‚å…³é”®å¸§ (åŒé‡ä¿é™©)
            // æŸäº›æµè§ˆå™¨åœ¨ resume åå¦‚æœä¸é©¬ä¸Šç»™ä¸ªå…³é”®å¸§ï¼Œä¼šé»‘å±å¾ˆä¹…
            if (kind === 'video') {
            // æˆ‘ä»¬å¯ä»¥åœ¨ consumer å†…éƒ¨ä¹Ÿå°è¯•è¯·æ±‚ä¸€ä¸‹ï¼ˆå¦‚æœ mediasoup-client æ”¯æŒï¼‰
            // æˆ–è€…ä¾èµ–åç«¯åˆšæ‰åŠ çš„ resumeConsumer é‡Œçš„ requestKeyFrame()
            console.log("Waiting for video keyframe...");
            }

            updateStatus(`æˆåŠŸæ¥æ”¶åˆ°æµ: ${producerId} (${kind})`);
        }
    </script>
</body>
</html>